{% extends "base.html" %}

{% block title %}Adicionar Novo Lançamento{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow-lg rounded-lg p-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">Adicionar Novo Lançamento</h1>
        
        {% if form.non_field_errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
                <strong class="font-bold">Erro de Validação!</strong>
                <ul>{% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</ul>
            </div>
        {% endif %}
        
        <form method="post">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Coluna da Esquerda -->
                <div>
                    <label for="{{ form.descricao.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.descricao.label }}</label>
                    {{ form.descricao }}
                </div>
                <div>
                    <label for="{{ form.valor.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.valor.label }}</label>
                    {{ form.valor }}
                </div>
                <div>
                    <label for="{{ form.tipo.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.tipo.label }}</label>
                    {{ form.tipo }}
                </div>
                <div>
                    <label for="{{ form.categoria.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.categoria.label }}</label>
                    {{ form.categoria }}
                </div>

                <!-- Coluna da Direita -->
                <div>
                    <label for="{{ form.data_competencia.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.data_competencia.label }}</label>
                    {{ form.data_competencia }}
                </div>
                <div>
                    <label for="{{ form.data_caixa.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.data_caixa.label }}</label>
                    {{ form.data_caixa }}
                </div>
                <div>
                    <label for="{{ form.conta_bancaria.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.conta_bancaria.label }} (se aplicável)</label>
                    {{ form.conta_bancaria }}
                </div>
                <div>
                    <label for="{{ form.cartao_credito.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.cartao_credito.label }} (se aplicável)</label>
                    {{ form.cartao_credito }}
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <a href="{% url 'core:home' %}" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</a>
                <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Salvar Lançamento</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Dados dos cartões passados pela View
        const cartoesData = {{ cartoes_data_json|default:'{}' }};

        // Seleciona os elementos do DOM
        const dataCompetenciaEl = document.getElementById('id_data_competencia');
        const dataCaixaEl = document.getElementById('id_data_caixa');
        const contaBancariaEl = document.getElementById('id_conta_bancaria');
        const cartaoCreditoEl = document.getElementById('id_cartao_credito');

        function calcularDataCaixa() {
            // Verifica se os elementos essenciais existem
            if (!dataCompetenciaEl || !dataCaixaEl) return;
            
            const dataCompetenciaStr = dataCompetenciaEl.value;
            if (!dataCompetenciaStr) return;

            const competencia = new Date(dataCompetenciaStr + 'T12:00:00');
            
            if (contaBancariaEl && contaBancariaEl.value) {
                dataCaixaEl.value = dataCompetenciaStr;
                return;
            }

            if (cartaoCreditoEl && cartaoCreditoEl.value) {
                const cartaoId = cartaoCreditoEl.value;
                const cartaoInfo = cartoesData[cartaoId];

                if (cartaoInfo) {
                    const diaCompetencia = competencia.getDate();
                    const diaFechamento = cartaoInfo.fechamento;
                    let dataVencimento = new Date(competencia);
                    
                    if (diaCompetencia > diaFechamento) {
                        dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                    }
                    dataVencimento.setDate(cartaoInfo.vencimento);
                    
                    const ano = dataVencimento.getFullYear();
                    const mes = String(dataVencimento.getMonth() + 1).padStart(2, '0');
                    const dia = String(dataVencimento.getDate()).padStart(2, '0');
                    
                    dataCaixaEl.value = `${ano}-${mes}-${dia}`;
                }
                return;
            }

            dataCaixaEl.value = '';
        }

        // Adiciona os gatilhos APENAS se os elementos existirem
        if (dataCompetenciaEl) dataCompetenciaEl.addEventListener('change', calcularDataCaixa);
        if (contaBancariaEl) contaBancariaEl.addEventListener('change', calcularDataCaixa);
        if (cartaoCreditoEl) cartaoCreditoEl.addEventListener('change', calcularDataCaixa);
    });
</script>
{{ block.super }}
{% endblock %}